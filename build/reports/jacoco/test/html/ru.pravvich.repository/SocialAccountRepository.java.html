<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SocialAccountRepository.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">account-manager-server</a> &gt; <a href="index.source.html" class="el_package">ru.pravvich.repository</a> &gt; <span class="el_source">SocialAccountRepository.java</span></div><h1>SocialAccountRepository.java</h1><pre class="source lang-java linenums">package ru.pravvich.repository;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NonNull;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Modifying;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;
import ru.pravvich.domain.SocialAccount;

import javax.persistence.criteria.CriteriaBuilder;
import javax.persistence.criteria.CriteriaQuery;
import javax.persistence.criteria.Predicate;
import javax.persistence.criteria.Root;
import java.sql.Timestamp;

import static java.util.Objects.nonNull;
import static ru.pravvich.util.QueryValFormatter.LikeStrategy.ANY;
import static ru.pravvich.util.QueryValFormatter.toLike;

@Repository
public interface SocialAccountRepository extends JpaRepository&lt;SocialAccount, Integer&gt;, JpaSpecificationExecutor&lt;SocialAccount&gt; {

    @Modifying
    @Transactional
    @Query(&quot;UPDATE SocialAccount acc set acc.phoneId = ?1 WHERE acc.phoneId = ?2&quot;)
    void setPhone(@NonNull Integer arg, @NonNull Integer old);

    @Modifying
    @Transactional
    @Query(&quot;UPDATE SocialAccount acc set acc.vdsId = ?1 WHERE acc.vdsId = ?2&quot;)
    void setVds(@NonNull Integer arg, @NonNull Integer old);

<span class="nc bnc" id="L39" title="All 2 branches missed.">    @AllArgsConstructor</span>
    class SocialAccountSpecification implements Specification&lt;SocialAccount&gt; {

        private final @NonNull SocialAccountFilter filter;

        @Override
        public Predicate toPredicate(Root&lt;SocialAccount&gt; root, CriteriaQuery&lt;?&gt; query, CriteriaBuilder cb) {
<span class="nc" id="L46">            Predicate predicate = cb.conjunction();</span>
<span class="nc bnc" id="L47" title="All 2 branches missed.">            if (nonNull(filter.id)) {</span>
<span class="nc" id="L48">                predicate.getExpressions().add(cb.equal(root.get(&quot;id&quot;), filter.id));</span>
            }
<span class="nc bnc" id="L50" title="All 2 branches missed.">            if (nonNull(filter.note)) {</span>
<span class="nc" id="L51">                predicate.getExpressions().add(cb.like(root.get(&quot;note&quot;), toLike(filter.note, ANY)));</span>
            }
<span class="nc bnc" id="L53" title="All 2 branches missed.">            if (nonNull(filter.status)) {</span>
<span class="nc" id="L54">                predicate.getExpressions().add(cb.like(root.get(&quot;status&quot;), toLike(filter.status, ANY)));</span>
            }
<span class="nc bnc" id="L56" title="All 2 branches missed.">            if (nonNull(filter.socialType)) {</span>
<span class="nc" id="L57">                predicate.getExpressions().add(cb.like(root.get(&quot;socialType&quot;), toLike(filter.socialType, ANY)));</span>
            }
<span class="nc bnc" id="L59" title="All 2 branches missed.">            if (nonNull(filter.login)) {</span>
<span class="nc" id="L60">                predicate.getExpressions().add(cb.like(root.get(&quot;login&quot;), toLike(filter.login, ANY)));</span>
            }
<span class="nc bnc" id="L62" title="All 2 branches missed.">            if (nonNull(filter.password)) {</span>
<span class="nc" id="L63">                predicate.getExpressions().add(cb.like(root.get(&quot;password&quot;), toLike(filter.password, ANY)));</span>
            }
<span class="nc bnc" id="L65" title="All 4 branches missed.">            if (nonNull(filter.from) &amp;&amp; nonNull(filter.to)) {</span>
<span class="nc" id="L66">                predicate.getExpressions().add(cb.between(root.get(&quot;regDate&quot;), filter.from, filter.to));</span>
            }
<span class="nc bnc" id="L68" title="All 2 branches missed.">            if (nonNull(filter.phoneId)) {</span>
<span class="nc" id="L69">                predicate.getExpressions().add(cb.equal(root.get(&quot;phoneId&quot;), filter.phoneId));</span>
            }
<span class="nc bnc" id="L71" title="All 2 branches missed.">            if (nonNull(filter.vdsId)) {</span>
<span class="nc" id="L72">                predicate.getExpressions().add(cb.equal(root.get(&quot;vdsId&quot;), filter.vdsId));</span>
            }
<span class="nc" id="L74">            return predicate;</span>
        }
    }

<span class="pc bpc" id="L78" title="68 of 98 branches missed.">    @Data</span>
    class SocialAccountFilter {

<span class="fc" id="L81">        private @NonNull Pageable pageable;</span>

<span class="fc" id="L83">        private Integer id;</span>

<span class="fc" id="L85">        private String note;</span>

<span class="fc" id="L87">        private String status;</span>

<span class="fc" id="L89">        private String socialType;</span>

<span class="fc" id="L91">        private String login;</span>

<span class="fc" id="L93">        private String password;</span>

<span class="fc" id="L95">        private Timestamp from;</span>

<span class="fc" id="L97">        private Timestamp to;</span>

<span class="fc" id="L99">        private Integer phoneId;</span>

<span class="fc" id="L101">        private Integer vdsId;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>